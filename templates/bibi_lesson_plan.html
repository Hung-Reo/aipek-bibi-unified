<!DOCTYPE html>
<html lang="vi">
<head>
  <script>
    // Thi·∫øt l·∫≠p ch·∫ø ƒë·ªô giao di·ªán ngay khi t·∫£i trang
    (function() {
      const savedUIMode = localStorage.getItem('bibi-ui-mode') || 'modern';
      if (savedUIMode === 'modern') {
        document.documentElement.classList.add('modern-ui');
      }
    })();
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BiBi So·∫°n Gi√°o √Ån</title>
  <!-- ‚úÖ FIXED: Use /static paths for unified deployment -->
  <link rel="stylesheet" href="/static/css/style.css" />
  <link rel="stylesheet" href="/static/css/bibi_grammar_modern.css" />
  <link rel="stylesheet" href="/static/css/lesson-plan.css" />

  <!-- ‚úÖ TH√äM CSS STYLES M·ªöI V√ÄO TRONG <head> SECTION ƒë·ªÉ m·ªù c√°c tab ch∆∞a xong -->
  <style>
    /* CSS ƒë·ªÉ disable tabs v√† hi·ªán tooltip */
    .tab-btn.coming-soon {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
        position: relative;
        transition: opacity 0.3s ease;
    }

    .tab-btn.coming-soon::after {
        content: "üöß ƒêang ph√°t tri·ªÉn";
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        opacity: 0;
        transition: opacity 0.3s ease;
        white-space: nowrap;
        z-index: 1000;
        pointer-events: none;
    }

    .tab-btn.coming-soon:hover::after {
        opacity: 1;
    }

    /* Dark theme support */
    .dark-theme .tab-btn.coming-soon::after {
        background: #555;
        color: #fff;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <!-- ‚úÖ FIXED: Use /static paths -->
  <script src="/static/libs/docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- ‚úÖ FIXED: Use /static paths -->
  <link rel="stylesheet" href="/static/css/print.css" media="print" />
  <!-- ‚úÖ FIXED: Use /static paths -->
  <script type="module" src="/static/js/controllers/feedback.js"></script>
</head>
<body>
  <!-- Container c√¥ l·∫≠p cho UI hi·ªán ƒë·∫°i -->
  <div class="bibi-lesson-plan-app" id="bibi-lesson-plan-app">
    <!-- Header m·ªõi -->
    <header class="smart-header">
      <div class="header-left">
        <a href="/index.html" class="home-btn">
          <i class="fas fa-home"></i>
          <!-- ‚úÖ FIXED: Use /static paths -->
          <img src="/static/images/petrusky-logo.png" alt="P√©trus K√Ω" class="school-logo">
        </a>
        <div class="logo-separator"></div>
        <div class="logo">ü§ñ BiBi</div>
      </div>
      
      <div class="header-center">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="topic-search" placeholder="T√¨m ki·∫øm ti√™u ƒë·ªÅ gi√°o √°n...">
        </div>
      </div>
      
      <div class="header-right">
        <!-- Ch·ªâ b√°o RAG -->
        <div id="rag-indicator" class="rag-status" title="Tr·∫°ng th√°i k·∫øt n·ªëi v·ªõi c∆° s·ªü d·ªØ li·ªáu">
          <i class="fas fa-database"></i>
          <span class="rag-status-text">RAG: ƒêang ki·ªÉm tra...</span>
        </div>
        <!-- N√∫t chuy·ªÉn ƒë·ªïi giao di·ªán m·ªõi -->
        <button id="ui-mode-toggle" class="ui-mode-switch">
          <i class="fas fa-sync-alt"></i>
          <span>Giao di·ªán</span>
        </button>
        <div class="language-selector">
          <button id="lang-vi" class="lang-btn active">üáªüá≥</button>
          <button id="lang-en" class="lang-btn">üá¨üáß</button>
          <button id="lang-both" class="lang-btn">üáªüá≥üá¨üáß</button>
        </div>
        <button id="theme-toggle" class="theme-btn">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </header>

  <!-- Navigation tabs d∆∞·ªõi header -->
  <nav class="tabs-navigation">
    <div class="tabs-container">
      <button id="main-tab" class="tab-btn active">
          <i class="fas fa-book"></i>
          <span>Gi√°o √°n ch√≠nh</span>
      </button>
      <button id="supplementary-tab" class="tab-btn">
          <i class="fas fa-list"></i>
          <span>Gi√°o √°n tƒÉng ti·∫øt</span>
      </button>
      <button id="review-tab" class="tab-btn">
        <i class="fas fa-redo"></i>
        <span>B√†i Review</span>
      </button>
      
      <button id="test-tab" class="tab-btn">
        <i class="fas fa-clipboard-check"></i>
        <span>Ki·ªÉm tra</span>
      </button>
      
      <button id="extracurricular-tab" class="tab-btn">
        <i class="fas fa-tasks"></i>
        <span>Ho·∫°t ƒë·ªông ngo·∫°i kh√≥a</span>
      </button>
    </div>
  </nav>

  <!-- Container ch√≠nh -->
  <div class="lesson-plan-container">
    <!-- Sidebar b√™n tr√°i cho Main, Supplementary, etc. -->
    <div class="lesson-plan-sidebar" id="main-sidebar">
      <h3>So·∫°n gi√°o √°n ti·∫øng Anh</h3>
      
      <div class="lesson-plan-form">
        <!-- N√∫t t·∫°o gi√°o √°n ·ªü ƒë·∫ßu form -->
        <button id="generate-lesson-plan-btn-top" class="action-btn primary-btn sticky-btn">
          <i class="fas fa-magic"></i> T·∫°o gi√°o √°n
        </button>
        <!-- Th√™m n√∫t k·∫øt h·ª£p (m·∫∑c ƒë·ªãnh ·∫©n) -->
        <button id="combine-lessons-btn" class="action-btn combine-btn" style="display: none;">
          <i class="fas fa-object-group"></i> K·∫øt h·ª£p c√°c ti·∫øt ƒë√£ t·∫°o
        </button>
        
        <!-- Form ƒë·ªông s·∫Ω ƒë∆∞·ª£c thay ƒë·ªïi d·ª±a v√†o lo·∫°i gi√°o √°n -->
        <div id="lesson-plan-form-container">
          <!-- PHASE 2: Wrap wizard trong container c√≥ class ƒë·ªÉ control visibility -->
          <div id="main-form-content" class="main-sidebar-content">
            <!-- Form Wizard s·∫Ω thay th·∫ø form m·∫∑c ƒë·ªãnh n√†y -->
            <div id="lesson-plan-wizard" class="form-wizard">
            <!-- Tab Navigator -->
            <div class="wizard-steps">
              <div class="wizard-step active" data-step="1">
                <span class="step-number">1</span>
                <span class="step-text">Th√¥ng tin c∆° b·∫£n</span>
              </div>
              <div class="wizard-step" data-step="2">
                <span class="step-number">2</span>
                <span class="step-text">Ch·ªçn n·ªôi dung</span>
              </div>
              <div class="wizard-step" data-step="3">
                <span class="step-number">3</span>
                <span class="step-text">Chi ti·∫øt b√†i h·ªçc</span>
              </div>
              <div class="wizard-step" data-step="4">
                <span class="step-number">4</span>
                <span class="step-text">Th·ªùi gian</span>
              </div>
              <div class="wizard-step" data-step="5">
                <span class="step-number">5</span>
                <span class="step-text">Th√¥ng tin b·ªï sung</span>
              </div>
            </div>
            
            <!-- Step Contents -->
            <div class="wizard-content">
              <!-- Step 1: Th√¥ng tin c∆° b·∫£n -->
              <div class="wizard-pane active" data-step="1">
                <div class="form-panel">
                  <div class="form-group">
                    <label for="grade-select">L·ªõp:</label>
                    <select id="grade-select" class="full-width">
                      <option value="6">L·ªõp 6</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="semester-select">H·ªçc k·ª≥:</label>
                    <select id="semester-select" class="full-width">
                      <option value="1">H·ªçc k·ª≥ 1</option>
                      <option value="2">H·ªçc k·ª≥ 2</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="unit-select">Ch·ªçn Unit:</label>
                    <select id="unit-select" class="full-width">
                      <option value="1">Unit 1</option>
                      <option value="2">Unit 2</option>
                      <option value="3">Unit 3</option>
                      <option value="4">Unit 4</option>
                      <option value="5">Unit 5</option>
                      <option value="6">Unit 6</option>
                      <option value="7">Unit 7</option>
                      <option value="8">Unit 8</option>
                      <option value="9">Unit 9</option>
                      <option value="10">Unit 10</option>
                      <option value="11">Unit 11</option>
                      <option value="12">Unit 12</option>
                    </select>
                </div>
                </div>
                
                <div class="wizard-actions">
                  <button class="wizard-next-btn">Ti·∫øp theo <i class="fas fa-arrow-right"></i></button>
                </div>
              </div>
              
              <!-- Step 2: Ch·ªçn n·ªôi dung -->
              <div class="wizard-pane" data-step="2">
                <!-- Ph·∫ßn Unit - s·∫Ω hi·ªÉn th·ªã khi ch·ªçn "B√†i h·ªçc ch√≠nh" -->
                <div class="form-panel unit-panel">
                  <div class="form-group">
                    <label for="unit-select">Unit:</label>
                    <select id="unit-select" class="full-width">
                      <!-- Options will be populated dynamically -->
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="lesson-select">B√†i h·ªçc:</label>
                    <select id="lesson-select" class="full-width">
                      <!-- Options will be populated dynamically -->
                    </select>
                  </div>
                </div>
                
                <!-- Ph·∫ßn TƒÉng ti·∫øt - s·∫Ω hi·ªÉn th·ªã khi ch·ªçn "B√†i tƒÉng ti·∫øt" -->
                <div class="form-panel supplementary-panel" style="display: none;">
                  <div class="form-group">
                    <label for="supp-unit-select">Unit li√™n quan:</label>
                    <select id="supp-unit-select" class="full-width">
                      <!-- Options will be populated dynamically -->
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="supp-type-select">Lo·∫°i k·ªπ nƒÉng:</label>
                    <select id="supp-type-select" class="full-width">
                      <option value="vocabulary">T·ª´ v·ª±ng (Vocabulary)</option>
                      <option value="grammar">Ng·ªØ ph√°p (Grammar)</option>
                      <option value="pronunciation">Ph√°t √¢m (Pronunciation)</option>
                      <option value="reading">ƒê·ªçc hi·ªÉu (Reading)</option>
                      <option value="listening">Nghe (Listening)</option>
                      <option value="speaking">N√≥i (Speaking)</option>
                      <option value="writing">Vi·∫øt (Writing)</option>
                    </select>
                  </div>
                </div>
                
                <div class="wizard-actions">
                  <button class="wizard-prev-btn"><i class="fas fa-arrow-left"></i> Quay l·∫°i</button>
                  <button class="wizard-next-btn">Ti·∫øp theo <i class="fas fa-arrow-right"></i></button>
                </div>
              </div>
              
              <!-- Step 3: Chi ti·∫øt b√†i h·ªçc -->
              <div class="wizard-pane" data-step="3">
                <div class="form-panel">
                  <div class="lesson-info-preview">
                    <div id="lesson-focus-display" class="info-preview-item">
                      <span class="info-label">Tr·ªçng t√¢m:</span>
                      <span class="info-value">Vocabulary & Pronunciation</span>
                    </div>
                    <div id="lesson-grammar-display" class="info-preview-item" style="display: none;">
                      <span class="info-label">Ng·ªØ ph√°p:</span>
                      <span class="info-value">Present Simple</span>
                    </div>
                    <div id="lesson-pronunciation-display" class="info-preview-item" style="display: none;">
                      <span class="info-label">Ph√°t √¢m:</span>
                      <span class="info-value">/…ëÀê/, / å/</span>
                    </div>
                  </div>
                  
                  <!-- C√°c tr∆∞·ªùng chi ti·∫øt kh√°c s·∫Ω hi·ªÉn th·ªã t√πy thu·ªôc v√†o lo·∫°i b√†i h·ªçc -->
                  <div id="dynamic-details-fields">
                    <!-- Fields will be populated dynamically -->
                  </div>
                </div>
                
                <div class="wizard-actions">
                  <button class="wizard-prev-btn"><i class="fas fa-arrow-left"></i> Quay l·∫°i</button>
                  <button class="wizard-next-btn">Ti·∫øp theo <i class="fas fa-arrow-right"></i></button>
                </div>
              </div>
              
              <!-- Step 4: Th·ªùi gian -->
              <div class="wizard-pane" data-step="4">
                <div class="form-panel">
                  <div class="form-group">
                    <label for="week-input">Tu·∫ßn h·ªçc:</label>
                    <input type="text" id="week-input" placeholder="Nh·∫≠p s·ªë tu·∫ßn (V√≠ d·ª•: 01)" class="full-width">
                  </div>
                  
                  <!-- Hi·ªÉn th·ªã th√¥ng tin tu·∫ßn -->
                  <div id="week-info-display" class="week-info-box" style="display: none;"></div>
                  
                  <!-- Dropdown ch·ªçn ti·∫øt -->
                  <div class="form-group lesson-selection" id="lesson-selection-container" style="display: none;">
                    <label for="lesson-select">Ti·∫øt h·ªçc:</label>
                    <select id="lesson-select" class="form-control">
                      <option value="getting-started">Ti·∫øt 1: Getting Started</option>
                      <option value="closer-look-1">Ti·∫øt 2: A closer look 1</option>
                      <option value="closer-look-2">Ti·∫øt 3: A closer look 2</option>
                      <option value="communication">Ti·∫øt 4: Communication</option>
                      <option value="skills-1">Ti·∫øt 5: Skills 1</option>
                      <option value="skills-2">Ti·∫øt 6: Skills 2</option>
                      <option value="looking-back">Ti·∫øt 7: Looking back & Project</option>
                    </select>
                  </div>
                  <script>
                    // Ki·ªÉm tra ph·∫ßn t·ª≠ c√≥ t·ªìn t·∫°i khi trang load kh√¥ng
                    document.addEventListener('DOMContentLoaded', function() {
                      console.log('lesson-selection-container exists:', !!document.getElementById('lesson-selection-container'));
                    });
                  </script>
                  
                  <div class="form-group">
                    <label for="additional-instructions">Y√™u c·∫ßu ƒë·∫∑c bi·ªát (n·∫øu c√≥):</label>
                    <textarea id="additional-instructions" rows="3" placeholder="Nh·∫≠p y√™u c·∫ßu ƒë·∫∑c bi·ªát n·∫øu c√≥"></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label for="preparing-date">Ng√†y so·∫°n:</label>
                    <input type="text" id="preparing-date" placeholder="VD: 22/03/2025">
                  </div>
                  
                  <div class="form-group">
                    <label for="teaching-date">Ng√†y d·∫°y:</label>
                    <input type="text" id="teaching-date" placeholder="VD: 24/03 - 28/03/2025">
                  </div>
                </div>
                
                <div class="preview-section">
                  <h4>Preview</h4>
                  <div class="preview-box">
                    <div id="preview-header" class="preview-header">
                      Week 13th<br>
                      Preparing day: 22/03/2025<br>
                      Teaching day: 24/03 - 28/03/2025<br>
                      <br>
                      UNIT 10: OUR HOUSES IN THE FUTURE<br>
                      Lesson 1: Getting started
                    </div>
                  </div>
                </div>
                
                <div class="wizard-actions">
                  <button class="wizard-prev-btn"><i class="fas fa-arrow-left"></i> Quay l·∫°i</button>
                  <button class="wizard-next-btn">Ti·∫øp theo <i class="fas fa-arrow-right"></i></button>
                </div>
              </div>
              
              <!-- Step 5: Th√¥ng tin b·ªï sung -->
              <div class="wizard-pane" data-step="5">
                <div class="form-panel">
                  <div class="form-group">
                    <label for="objectives-textarea">M·ª•c ti√™u b√†i h·ªçc:</label>
                    <textarea id="objectives-textarea" rows="3" placeholder="Nh·∫≠p m·ª•c ti√™u ch√≠nh c·ªßa b√†i h·ªçc"></textarea>
                  </div>
                  
                </div>
                
                <div class="wizard-actions">
                  <button class="wizard-prev-btn"><i class="fas fa-arrow-left"></i> Quay l·∫°i</button>
                  <button class="wizard-complete-btn primary-btn"><i class="fas fa-magic"></i> T·∫°o gi√°o √°n</button>
                </div>
              </div>
            </div>
          </div>
          <!-- PHASE 1: Review Form Section - Hidden by default -->
          <div id="review-form-section" class="review-form-section" style="display: none;">
            <h3>So·∫°n b√†i Review</h3>
            
            <div class="lesson-plan-form">
              <!-- N√∫t t·∫°o Review ·ªü ƒë·∫ßu form -->
              <button id="generate-review-btn-main" class="action-btn primary-btn sticky-btn">
                <i class="fas fa-redo"></i> T·∫°o b√†i Review
              </button>
              
              <!-- Review Form Content -->
              <div class="review-form-container">
                <div class="form-panel">
                  <div class="form-group">
                    <label for="grade-select">L·ªõp:</label>
                    <select id="grade-select" class="full-width">
                      <option value="6">L·ªõp 6</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="review-semester-select-main">H·ªçc k·ª≥:</label>
                    <select id="review-semester-select-main" class="full-width">
                      <option value="1">H·ªçc k·ª≥ 1</option>
                      <option value="2">H·ªçc k·ª≥ 2</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="review-select-main">Review:</label>
                    <select id="review-select-main" class="full-width">
                      <option value="1">Review 1 (Units 1-3)</option>
                      <option value="2">Review 2 (Units 4-6)</option>
                      <option value="3">Review 3 (Units 7-9)</option>
                      <option value="4">Review 4 (Units 10-12)</option>
                    </select>
                  </div>
                  
                  <!-- K·ªπ nƒÉng √¥n t·∫≠p -->
                  <div class="form-group review-skills-container">
                    <label>Ch·ªçn k·ªπ nƒÉng √¥n t·∫≠p (c√≥ th·ªÉ ch·ªçn nhi·ªÅu):</label>
                    <div class="skills-checkboxes">
                      <label class="checkbox-container">
                        <input type="checkbox" name="review-skill-main" value="vocabulary" checked> Vocabulary (T·ª´ v·ª±ng)
                      </label>
                      <label class="checkbox-container">
                        <input type="checkbox" name="review-skill-main" value="pronunciation" checked> Pronunciation (Ph√°t √¢m)
                      </label>
                      <label class="checkbox-container">
                        <input type="checkbox" name="review-skill-main" value="grammar" checked> Grammar (Ng·ªØ ph√°p)
                      </label>
                      <label class="checkbox-container">
                        <input type="checkbox" name="review-skill-main" value="reading"> Reading (ƒê·ªçc)
                      </label>
                      <label class="checkbox-container">
                        <input type="checkbox" name="review-skill-main" value="writing"> Writing (Vi·∫øt)
                      </label>
                      <label class="checkbox-container">
                        <input type="checkbox" name="review-skill-main" value="listening"> Listening (Nghe)
                      </label>
                      <label class="checkbox-container">
                        <input type="checkbox" name="review-skill-main" value="speaking"> Speaking (N√≥i)
                      </label>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label for="review-additional-instructions-main">Y√™u c·∫ßu ƒë·∫∑c bi·ªát (n·∫øu c√≥):</label>
                    <textarea id="review-additional-instructions-main" rows="3" placeholder="Nh·∫≠p y√™u c·∫ßu ƒë·∫∑c bi·ªát n·∫øu c√≥"></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div><!-- ƒê√≥ng main-form-content wrapper -->

    <!-- PHASE 6: Review Sidebar - Restored for testing -->
    <div class="lesson-plan-sidebar" id="review-sidebar" style="display: none;">
      <h3>So·∫°n b√†i Review</h3>
      
      <div class="lesson-plan-form">
        <!-- N√∫t t·∫°o Review ·ªü ƒë·∫ßu form -->
        <button id="generate-review-btn-top" class="action-btn primary-btn sticky-btn">
          <i class="fas fa-redo"></i> T·∫°o b√†i Review
        </button>
        
        <!-- Review Form -->
        <div id="review-form-container">
          <div class="form-panel">
            <div class="form-group">
              <label for="grade-select">L·ªõp:</label>
              <select id="grade-select" class="full-width">
                <option value="6">L·ªõp 6</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="review-semester-select">H·ªçc k·ª≥:</label>
              <select id="review-semester-select" class="full-width">
                <option value="1">H·ªçc k·ª≥ 1</option>
                <option value="2">H·ªçc k·ª≥ 2</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="review-type-select-main">Review:</label>
              <select id="review-type-select-main" class="full-width">
                <!-- Options will be populated dynamically -->
              </select>
            </div>
            
            <!-- K·ªπ nƒÉng √¥n t·∫≠p -->
            <div class="form-group review-skills-container" id="review-skills-main-container">
              <label>Ch·ªçn k·ªπ nƒÉng √¥n t·∫≠p (c√≥ th·ªÉ ch·ªçn nhi·ªÅu):</label>
              <div class="skills-checkboxes" id="review-skills-main-checkboxes">
                <label class="checkbox-container">
                  <input type="checkbox" name="review-skill-main" value="vocabulary"> Vocabulary (T·ª´ v·ª±ng)
                </label>
                <label class="checkbox-container">
                  <input type="checkbox" name="review-skill-main" value="pronunciation"> Pronunciation (Ph√°t √¢m)
                </label>
                <label class="checkbox-container">
                  <input type="checkbox" name="review-skill-main" value="grammar"> Grammar (Ng·ªØ ph√°p)
                </label>
                <label class="checkbox-container">
                  <input type="checkbox" name="review-skill-main" value="reading"> Reading (ƒê·ªçc)
                </label>
                <label class="checkbox-container">
                  <input type="checkbox" name="review-skill-main" value="writing"> Writing (Vi·∫øt)
                </label>
                <label class="checkbox-container">
                  <input type="checkbox" name="review-skill-main" value="listening"> Listening (Nghe)
                </label>
                <label class="checkbox-container">
                  <input type="checkbox" name="review-skill-main" value="speaking"> Speaking (N√≥i)
                </label>
              </div>
            </div>
            
            <div class="form-group">
              <label for="review-week-input">Tu·∫ßn h·ªçc:</label>
              <input type="text" id="review-week-input" placeholder="Nh·∫≠p s·ªë tu·∫ßn (V√≠ d·ª•: 01)" class="full-width">
            </div>
            
            <div class="form-group">
              <label for="review-additional-instructions">Y√™u c·∫ßu ƒë·∫∑c bi·ªát (n·∫øu c√≥):</label>
              <textarea id="review-additional-instructions" rows="3" placeholder="Nh·∫≠p y√™u c·∫ßu ƒë·∫∑c bi·ªát n·∫øu c√≥"></textarea>
            </div>
            
            <div class="form-group">
              <label for="review-preparing-date">Ng√†y so·∫°n:</label>
              <input type="text" id="review-preparing-date" placeholder="VD: 22/03/2025">
            </div>
            
            <div class="form-group">
              <label for="review-teacher-name">T√™n gi√°o vi√™n:</label>
              <input type="text" id="review-teacher-name" placeholder="Nh·∫≠p t√™n gi√°o vi√™n">
            </div>
          </div>
        </div>
      </div>

      <!-- FIX: Review Form Section ƒë·ªÉ support Review tab -->
      <div id="review-form-section" class="review-form-section" style="display: none;">
        <h3>So·∫°n b√†i Review</h3>
        
        <!-- N√∫t t·∫°o Review -->
        <button id="generate-review-btn-main" class="action-btn primary-btn sticky-btn">
          <i class="fas fa-redo"></i> T·∫°o b√†i Review
        </button>
        
        <!-- Form content -->
        <div class="form-panel">
          <div class="form-group">
            <label for="review-select-main">Review:</label>
            <select id="review-select-main" class="full-width">
              <option value="1">Review 1 (Units 1-3)</option>
              <option value="2">Review 2 (Units 4-6)</option>
              <option value="3">Review 3 (Units 7-9)</option>
              <option value="4">Review 4 (Units 10-12)</option>
            </select>
          </div>
          
          <div class="form-group review-skills-container">
            <label>Ch·ªçn k·ªπ nƒÉng √¥n t·∫≠p:</label>
            <div class="skills-checkboxes">
              <label class="checkbox-container">
                <input type="checkbox" name="review-skill-main" value="vocabulary" checked> Vocabulary
              </label>
              <label class="checkbox-container">
                <input type="checkbox" name="review-skill-main" value="grammar" checked> Grammar
              </label>
              <label class="checkbox-container">
                <input type="checkbox" name="review-skill-main" value="pronunciation" checked> Pronunciation
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ FIXED: Khu v·ª±c n·ªôi dung b√™n ph·∫£i - T·∫§T C·∫¢ OUTPUT DIVS ƒê√É ƒê∆Ø·ª¢C TH√äM -->
    <div class="lesson-plan-content">
      <!-- Tab content: Gi√°o √°n ch√≠nh -->
      <div id="main-content" class="tab-content active">
        <div id="main-output" class="output-area">
          <div class="welcome-message">
            <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi tr·ª£ l√Ω so·∫°n gi√°o √°n!</h3>
            <p>Ch·ªçn m·ªôt lo·∫°i gi√°o √°n v√† ƒëi·ªÅn th√¥ng tin b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
            <p>C√¥ng c·ª• n√†y gi√∫p gi√°o vi√™n:</p>
            <ul>
              <li>T·∫°o gi√°o √°n chi ti·∫øt d·ª±a tr√™n s√°ch gi√°o khoa v√† ch∆∞∆°ng tr√¨nh gi√°o d·ª•c ch√≠nh th·ª©c</li>
              <li>Ti·∫øt ki·ªám th·ªùi gian so·∫°n gi√°o √°n th√¥ng qua AI v√† c∆° s·ªü tri th·ª©c</li>
              <li>T√πy ch·ªânh gi√°o √°n theo nhu c·∫ßu c·ª• th·ªÉ</li>
              <li>Xu·∫•t v√† l∆∞u gi√°o √°n d·ªÖ d√†ng</li>
            </ul>
          </div>
          <!--TƒÉng s·ª± th√¢n thi·ªán, sinh ƒë·ªông trong ph·∫ßn hi·ªÉn th·ªã c√°c kh·ªëi n·ªôi dung-->
          <div class="vocab-block">
            <h4>üìò Vocabulary Item: Subject</h4>
            <ul>
              <li><strong>Form:</strong> subject</li>
              <li><strong>Meaning:</strong> m√¥n h·ªçc</li>
              <li><strong>Pronunciation:</strong> /Ààs åbd í…™kt/</li>
              <li><strong>Example:</strong> English is my favorite subject.</li>
            </ul>
          </div>
          
          <div class="analysis-block">
            üß† <strong>Grammar:</strong> This is + danh t·ª´<br>
            V√≠ d·ª•: This is my school.
          </div>
          
          <div class="example-block">
            ‚úç Example: I go to school every day.
          </div>
          
          <div class="activity-block">
            üé≤ <strong>Game: Bingo Vocabulary</strong>
            <ul>
              <li>Ph√°t phi·∫øu t·ª´ v·ª±ng</li>
              <li>Nghe ‚Äì ƒë√°nh d·∫•u t·ª´</li>
              <li>H·ªçc sinh th·∫Øng s·∫Ω d·ªãch + ƒë·ªçc l·∫°i t·ª´</li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- ‚úÖ FIXED: Tab content: B√†i Review -->
      <div id="review-content" class="tab-content">
        <div id="review-output" class="output-area">
          <div class="welcome-message tab-welcome-message" id="review-welcome-message">
            <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi tr·ª£ l√Ω so·∫°n b√†i Review!</h3>
            <p>Ch·ªçn Review v√† k·ªπ nƒÉng c·∫ßn √¥n t·∫≠p b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
            <p>C√¥ng c·ª• n√†y gi√∫p gi√°o vi√™n:</p>
            <ul>
              <li>T·∫°o b√†i Review t·ªïng h·ª£p ki·∫øn th·ª©c t·ª´ nhi·ªÅu Unit</li>
              <li>L·ª±a ch·ªçn k·ªπ nƒÉng c·∫ßn √¥n t·∫≠p (Vocabulary, Grammar, Reading, Writing...)</li>
              <li>Thi·∫øt k·∫ø ho·∫°t ƒë·ªông √¥n t·∫≠p ph√π h·ª£p v·ªõi tr√¨nh ƒë·ªô h·ªçc sinh</li>
              <li>Xu·∫•t v√† l∆∞u gi√°o √°n d·ªÖ d√†ng</li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- ‚úÖ FIXED: Tab content: Gi√°o √°n tƒÉng ti·∫øt -->
      <div id="supplementary-content" class="tab-content">
        <div id="supplementary-output" class="output-area">
          <div class="welcome-message tab-welcome-message" id="supplementary-welcome-message">
            <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi tr·ª£ l√Ω so·∫°n gi√°o √°n tƒÉng ti·∫øt!</h3>
            <p>Ch·ªçn m·ªôt lo·∫°i gi√°o √°n v√† ƒëi·ªÅn th√¥ng tin b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
            <p>C√¥ng c·ª• n√†y gi√∫p gi√°o vi√™n:</p>
            <ul>
              <li>T·∫°o b√†i t·∫≠p tƒÉng c∆∞·ªùng cho t·ª´ng k·ªπ nƒÉng (Vocabulary, Grammar, Pronunciation...)</li>
              <li>Thi·∫øt k·∫ø ho·∫°t ƒë·ªông ph√π h·ª£p v·ªõi tu·∫ßn h·ªçc v√† Unit ƒë√£ ch·ªçn</li>
              <li>T√πy ch·ªânh n·ªôi dung ph√π h·ª£p v·ªõi nhu c·∫ßu l·ªõp h·ªçc</li>
              <li>Xu·∫•t v√† l∆∞u gi√°o √°n d·ªÖ d√†ng</li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- ‚úÖ FIXED: Tab content: Ki·ªÉm tra -->
      <div id="test-content" class="tab-content">
        <div id="test-output" class="output-area">
          <div class="welcome-message tab-welcome-message" id="test-welcome-message">
            <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi tr·ª£ l√Ω so·∫°n ƒë·ªÅ ki·ªÉm tra!</h3>
            <p>Ch·ªçn th√¥ng tin c·∫ßn thi·∫øt b√™n tr√°i ƒë·ªÉ t·∫°o ƒë·ªÅ ki·ªÉm tra cho h·ªçc sinh.</p>
            <p>C√¥ng c·ª• n√†y gi√∫p gi√°o vi√™n:</p>
            <ul>
              <li>T·∫°o ƒë·ªÅ ki·ªÉm tra ph√π h·ª£p v·ªõi Review v√† k·ªπ nƒÉng c·∫ßn ƒë√°nh gi√°</li>
              <li>ƒêi·ªÅu ch·ªânh ƒë·ªô kh√≥ ph√π h·ª£p v·ªõi tr√¨nh ƒë·ªô h·ªçc sinh</li>
              <li>T√πy ch·ªânh n·ªôi dung ƒë·ªÅ ki·ªÉm tra theo nhu c·∫ßu ri√™ng</li>
              <li>Xu·∫•t v√† l∆∞u ƒë·ªÅ ki·ªÉm tra ƒë·ªÉ s·ª≠ d·ª•ng</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- ‚úÖ FIXED: Tab content: Ho·∫°t ƒë·ªông ngo·∫°i kh√≥a -->
      <div id="extracurricular-content" class="tab-content">
        <div id="extracurricular-output" class="output-area">
          <div class="welcome-message tab-welcome-message" id="extracurricular-welcome-message">
            <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi tr·ª£ l√Ω so·∫°n ho·∫°t ƒë·ªông ngo·∫°i kh√≥a!</h3>
            <p>Ch·ªçn th√¥ng tin c·∫ßn thi·∫øt b√™n tr√°i ƒë·ªÉ t·∫°o k·∫ø ho·∫°ch ho·∫°t ƒë·ªông ngo·∫°i kh√≥a.</p>
            <p>C√¥ng c·ª• n√†y gi√∫p gi√°o vi√™n:</p>
            <ul>
              <li>Thi·∫øt k·∫ø ho·∫°t ƒë·ªông ngo·∫°i kh√≥a ph√π h·ª£p v·ªõi ch·ªß ƒë·ªÅ v√† c·∫•p ƒë·ªô</li>
              <li>T·∫°o k·∫ø ho·∫°ch chi ti·∫øt cho t·ª´ng ho·∫°t ƒë·ªông</li>
              <li>T√πy ch·ªânh th·ªùi l∆∞·ª£ng v√† n·ªôi dung ph√π h·ª£p</li>
              <li>Xu·∫•t v√† l∆∞u d·ªÖ d√†ng</li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- Tab content: L·ªãch s·ª≠ -->
      <div id="history-content" class="tab-content">
        <div id="history-output" class="output-area">
          <div class="history-container">
            <h3>L·ªãch s·ª≠ gi√°o √°n</h3>
            <p>C√°c gi√°o √°n ƒë√£ t·∫°o g·∫ßn ƒë√¢y s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
            <div id="history-list" class="history-list">
              <!-- Danh s√°ch gi√°o √°n s·∫Ω ƒë∆∞·ª£c th√™m v√†o b·∫±ng JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <div class="loading-indicator" id="loading-indicator" style="display:none;">
        <div class="spinner"></div>
        <p>ƒêang x·ª≠ l√Ω...</p>
      </div>
    </div>
  </div>

  <!-- ‚úÖ FIXED: Import scripts v·ªõi /static paths cho unified deployment -->
  <script src="/static/js/controllers/api.js"></script>
  <script src="/static/js/controllers/ui-mode-manager.js" type="module"></script>
  <script src="/static/js/controllers/lesson-plan/lesson-plan-main.js" type="module"></script>

  <!-- Th√™m script kh·ªüi ƒë·ªông -->
  <script type="module">
    // Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng khi trang ƒë√£ t·∫£i
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ BiBi Lesson Plan app initialized');
      
      // Ki·ªÉm tra tr·∫°ng th√°i dark mode
      if (localStorage.getItem('bibi-theme') === 'dark') {
        document.body.classList.add('dark-theme');
      }
      
      // Ki·ªÉm tra phi√™n b·∫£n cho c·∫≠p nh·∫≠t cache
      const APP_VERSION = '1.0.0';
      const lastVersion = localStorage.getItem('bibi-lesson-plan-version');
      
      if (lastVersion !== APP_VERSION) {
        // X√≥a cache khi c·∫≠p nh·∫≠t phi√™n b·∫£n
        console.log('Ph√°t hi·ªán phi√™n b·∫£n m·ªõi, ƒëang x√≥a cache...');
        localStorage.setItem('bibi-lesson-plan-version', APP_VERSION);
        
        // Import LessonPlanCache v√† x√≥a cache
        import('/static/js/controllers/lesson-plan/lesson-plan-cache.js').then(module => {
          const LessonPlanCache = module.LessonPlanCache;
          const cleared = LessonPlanCache.clearAllCache();
          console.log(`ƒê√£ x√≥a ${cleared} m·ª•c cache c≈©`);
        }).catch(err => {
          console.error('L·ªói khi x√≥a cache:', err);
        });
      }
    });
  </script>

  <script>
  // Script k√≠ch ho·∫°t Unit-centric khi trang ƒë√£ t·∫£i
  document.addEventListener('DOMContentLoaded', function() {
    // Ch·ªù 500ms ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ c√°c th√†nh ph·∫ßn ƒë√£ t·∫£i xong
    setTimeout(function() {
      console.log("K√≠ch ho·∫°t t√≠nh nƒÉng Unit-centric...");
      
      // 1. Ki·ªÉm tra xem controller ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o ch∆∞a
      if (window.lessonPlanController) {
        // 2. N·∫øu ƒë√£ c√≥ uiController v√† h√†m initUnitCentricUI, g·ªçi n√≥  
        if (window.lessonPlanController?.uiController?.initUnitCentricUI) {
          window.lessonPlanController.uiController.initUnitCentricUI();
          console.log("ƒê√£ k√≠ch ho·∫°t initUnitCentricUI");
        }

        // 3. N·∫øu ch∆∞a c√≥, th·ª≠ c√°c c√°ch kh√°c
        else {
          console.warn("Kh√¥ng t√¨m th·∫•y h√†m initUnitCentricUI, th·ª≠ ph∆∞∆°ng ph√°p thay th·∫ø");
          
          // 3a. Th·ª≠ ·∫©n tr∆∞·ªùng nh·∫≠p tu·∫ßn tr·ª±c ti·∫øp
          const weekInputs = document.querySelectorAll('#week-input, input[placeholder*="tu·∫ßn"]');
          weekInputs.forEach(input => {
            if (input && input.parentElement) {
              input.parentElement.style.display = 'none';
              console.log("ƒê√£ ·∫©n tr∆∞·ªùng nh·∫≠p tu·∫ßn:", input.id || input.name);
            }
          });
          
          // 3b. Th·ª≠ hi·ªÉn th·ªã dropdown Unit tr·ª±c ti·∫øp
          const unitSelects = document.querySelectorAll('#unit-select, select[id^="unit"]');
          unitSelects.forEach(select => {
            if (select && select.parentElement) {
              select.parentElement.style.display = 'block';
              select.parentElement.style.marginTop = '20px';
              console.log("ƒê√£ hi·ªÉn th·ªã dropdown Unit:", select.id || select.name);
              
              // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh v√† k√≠ch ho·∫°t s·ª± ki·ªán change
              if (!select.value && select.options.length > 0) {
                select.value = "1";
                
                // K√≠ch ho·∫°t s·ª± ki·ªán change
                const event = new Event('change');
                select.dispatchEvent(event);
                console.log("ƒê√£ k√≠ch ho·∫°t s·ª± ki·ªán change cho Unit 1");
              }
            }
          });
        }
      }
      // 4. N·∫øu controller ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o, ƒë·∫∑t l·∫°i timeout d√†i h∆°n
      else {
        console.warn("Ch∆∞a t√¨m th·∫•y lessonPlanController, s·∫Ω th·ª≠ l·∫°i sau 1 gi√¢y");
        setTimeout(function() {
          if (window.lessonPlanController && typeof window.lessonPlanController.initUnitCentricUI === 'function') {
            window.lessonPlanController.initUnitCentricUI();
            console.log("ƒê√£ k√≠ch ho·∫°t initUnitCentricUI (l·∫ßn 2)");
          }
        }, 1000);
      }
      
      console.log("Ho√†n t·∫•t k√≠ch ho·∫°t Unit-centric");
    }, 500);
  });
  </script>

  <script>
  // Script kh·∫Øc ph·ª•c l·ªói xung ƒë·ªôt Unit/Review
    document.addEventListener('DOMContentLoaded', function() {
    // Ch·ªù 700ms ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ c√°c th√†nh ph·∫ßn ƒë√£ t·∫£i xong
    setTimeout(function() {
      console.log("Kh·∫Øc ph·ª•c l·ªói xung ƒë·ªôt Unit/Review...");
      
      // 1. ƒê·∫¢M B·∫¢O C√ÅC RADIO BUTTONS LU√îN HI·ªÇN TH·ªä
      const radioGroup = document.querySelector('.radio-group');
      if (radioGroup) {
        radioGroup.style.display = 'block';
      }
      
      // ƒê·∫£m b·∫£o c√°c label ch·ª©a radio buttons hi·ªÉn th·ªã
      document.querySelectorAll('input[type="radio"][name="lesson-type"]').forEach(radio => {
        if (radio && radio.parentElement) {
          radio.parentElement.style.display = 'block';
          // Hi·ªÉn th·ªã th√™m ph·∫ßn t·ª≠ cha c·ªßa parent ƒë·ªÉ ƒë·∫£m b·∫£o label hi·ªÉn th·ªã ƒë√∫ng
          if (radio.parentElement.parentElement) {
            radio.parentElement.parentElement.style.display = 'block';
          }
        }
      });
      
      // 2. Ki·ªÉm tra radio n√†o ƒë∆∞·ª£c ch·ªçn v√† x·ª≠ l√Ω t∆∞∆°ng ·ª©ng
      const reviewRadio = document.querySelector('input[type="radio"][value="review"]:checked');
      const unitRadio = document.querySelector('input[type="radio"][value="unit"]:checked');
      
      if (reviewRadio && reviewRadio.checked) {
        console.log("Ph√°t hi·ªán Review ƒë∆∞·ª£c ch·ªçn, ƒëang kh·∫Øc ph·ª•c...");
        
        // Hi·ªÉn th·ªã ph·∫ßn Review
        const reviewSelect = document.querySelector('#review-select');
        if (reviewSelect && reviewSelect.parentElement) {
          reviewSelect.parentElement.style.display = 'block';
        }
        
        const reviewSkillsContainer = document.querySelector('#review-skills-container');
        if (reviewSkillsContainer) {
          reviewSkillsContainer.style.display = 'block';
        }
        
        // ·∫®n dropdown Unit v√† lesson-select c·ª• th·ªÉ
        const unitSelect = document.querySelector('#unit-select');
        if (unitSelect && unitSelect.parentElement) {
          unitSelect.parentElement.style.display = 'none';
        }
        
        const lessonSelect = document.querySelector('#lesson-select');
        if (lessonSelect && lessonSelect.parentElement) {
          lessonSelect.parentElement.style.display = 'none';
        }
        
        console.log("ƒê√£ kh·∫Øc ph·ª•c xung ƒë·ªôt Review/Unit - hi·ªÉn th·ªã Review");
      } 
      else if (unitRadio && unitRadio.checked) {
        console.log("Ph√°t hi·ªán Unit ƒë∆∞·ª£c ch·ªçn, ƒëang kh·∫Øc ph·ª•c...");
        
        // Hi·ªÉn th·ªã dropdown Unit
        const unitSelect = document.querySelector('#unit-select');
        if (unitSelect && unitSelect.parentElement) {
          unitSelect.parentElement.style.display = 'block';
        }
        
        // Hi·ªÉn th·ªã dropdown lesson-select
        const lessonSelect = document.querySelector('#lesson-select');
        if (lessonSelect && lessonSelect.parentElement) {
          lessonSelect.parentElement.style.display = 'block';
        }
        
        // ·∫®n dropdown Review v√† k·ªπ nƒÉng
        const reviewSelect = document.querySelector('#review-select');
        if (reviewSelect && reviewSelect.parentElement) {
          reviewSelect.parentElement.style.display = 'none';
        }
        
        const reviewSkillsContainer = document.querySelector('#review-skills-container');
        if (reviewSkillsContainer) {
          reviewSkillsContainer.style.display = 'none';
        }
        
        console.log("ƒê√£ kh·∫Øc ph·ª•c xung ƒë·ªôt Review/Unit - hi·ªÉn th·ªã Unit");
      }
      else {
        // N·∫øu ch∆∞a ch·ªçn, hi·ªÉn th·ªã c·∫£ radio buttons
        console.log("Ch∆∞a c√≥ lo·∫°i b√†i n√†o ƒë∆∞·ª£c ch·ªçn, hi·ªÉn th·ªã c·∫£ hai l·ª±a ch·ªçn");
        
        // M·∫∑c ƒë·ªãnh ch·ªçn Unit
        if (unitRadio && !unitRadio.checked && !reviewRadio) {
          unitRadio.checked = true;
          // K√≠ch ho·∫°t s·ª± ki·ªán change
          unitRadio.dispatchEvent(new Event('change'));
        }
      }
    }, 700);
  });
  </script>
</body>
</html>