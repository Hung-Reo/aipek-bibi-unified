// /static/js/controllers/lesson-plan/lesson-plan-rag.js
// Module káº¿t ná»‘i vá»›i dá»‹ch vá»¥ RAG cho tÃ­nh nÄƒng Soáº¡n giÃ¡o Ã¡n

// âœ… NEW IMPORT: Access to UNITS_DATA for unit name lookup
import { UNITS_DATA } from './lesson-plan-prompts.js';

export class LessonPlanRAG {
    constructor(options = {}) {
        // XÃ¡c Ä‘á»‹nh base URL cho mÃ´i trÆ°á»ng phÃ¡t triá»ƒn vÃ  sáº£n xuáº¥t
        const baseUrl = window.location.origin; // Unified deployment

        // ÄÆ°á»ng dáº«n API
        this.apiUrl = options.apiUrl || `${baseUrl}/api/rag`; 
        this.healthUrl = `${baseUrl}/api/health`;
        
        // Danh sÃ¡ch cÃ¡c namespace Ä‘á»ƒ tÃ¬m kiáº¿m
        this.namespaces = options.namespaces || ["bibi_sgk", "bibi_ctgd", "bibi_lesson_plan"];
        this.defaultNamespace = options.defaultNamespace || "bibi_lesson_plan"; 
        
        this.defaultTopK = options.topK || 5; // TÄƒng lÃªn 5 Ä‘á»ƒ cÃ³ Ä‘á»§ ngá»¯ cáº£nh cho giÃ¡o Ã¡n
        this.isAvailable = false; // Máº·c Ä‘á»‹nh chÆ°a káº¿t ná»‘i
        this.debug = options.debug || false;
        this.enabled = options.enabled !== false;
        
        console.log(`ðŸ”„ Lesson Plan RAG API URL: ${this.apiUrl}`);
        console.log(`ðŸ“š Lesson Plan RAG Namespaces: ${this.namespaces.join(', ')}`);
    }

    // Kiá»ƒm tra káº¿t ná»‘i Ä‘áº¿n API
    async checkConnection() {
        if (!this.enabled) {
            console.log('ðŸ’¤ RAG Ä‘Ã£ bá»‹ táº¯t trong cáº¥u hÃ¬nh');
            return false;
        }
        
        try {
            console.log('ðŸ” Kiá»ƒm tra káº¿t ná»‘i RAG cho giÃ¡o Ã¡n...');
            
            // Gá»i endpoint health check
            const response = await fetch(this.healthUrl, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
                signal: AbortSignal.timeout(5000) // 5 giÃ¢y timeout
            });
            
            if (!response.ok) {
                throw new Error(`Lá»—i HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            // Cháº¥p nháº­n cáº£ 'success' vÃ  'ok' lÃ  tráº¡ng thÃ¡i thÃ nh cÃ´ng
            this.isAvailable = (data.status === 'success' || data.status === 'ok');
            
            if (this.isAvailable) {
                console.log(`âœ… Káº¿t ná»‘i RAG giÃ¡o Ã¡n thÃ nh cÃ´ng: ${data.message}`);
                
                // Kiá»ƒm tra xem cÃ³ dá»¯ liá»‡u Pinecone khÃ´ng
                if (data.pinecone_index && data.default_namespace) {
                    console.log(`ðŸ“Š Pinecone index: ${data.pinecone_index}, namespace máº·c Ä‘á»‹nh: ${data.default_namespace}`);
                } else {
                    // Váº«n Ä‘Æ°á»£c coi lÃ  thÃ nh cÃ´ng ngay cáº£ khi khÃ´ng cÃ³ thÃ´ng tin Pinecone cá»¥ thá»ƒ
                    console.log(`ðŸ“Š Káº¿t ná»‘i thÃ nh cÃ´ng, khÃ´ng cÃ³ thÃ´ng tin chi tiáº¿t vá» Pinecone`);
                }
            } else {
                console.error('âŒ API RAG khÃ´ng sáºµn sÃ ng cho giÃ¡o Ã¡n');
            }
            
            return this.isAvailable;
        }
        catch (error) {
            console.error('âŒ Lá»—i kiá»ƒm tra káº¿t ná»‘i RAG giÃ¡o Ã¡n:', error);
            
            // Trong mÃ´i trÆ°á»ng phÃ¡t triá»ƒn, giáº£ láº­p káº¿t ná»‘i thÃ nh cÃ´ng
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.warn('âš ï¸ Äang á»Ÿ mÃ´i trÆ°á»ng phÃ¡t triá»ƒn: Giáº£ láº­p káº¿t ná»‘i RAG thÃ nh cÃ´ng máº·c dÃ¹ cÃ³ lá»—i');
                this.isAvailable = true;
                return true;
            }
            
            this.isAvailable = false;
            return false;
        }
    }

    // ðŸ”¥ GET TIMEOUT CONFIGURATION - PHASE 2 OPTIMIZED
    getTimeoutConfiguration(lessonType = 'main') {
        // Main timeout configuration - OPTIMIZED for 3-namespace coverage
        const mainTimeouts = {
            'bibi_ctgd': 35000,       // Working fine vá»›i 35s
            'bibi_sgk': 30000,        // Working fine vá»›i 30s  
            'bibi_lesson_plan': 45000, // âœ… PHASE 2 FIX: 25s â†’ 45s (backend cáº§n >25s)
            'default': 30000
        };
        
        // Supplementary timeout configuration (EXTENDED FOR BETTER SUCCESS)
        const supplementaryTimeouts = {
            'bibi_ctgd': 55000,       // +20s (backend needs 35s + network + safety)
            'bibi_sgk': 50000,        // +20s (backend needs 30s + network + safety)
            'bibi_lesson_plan': 45000, // Consistent vá»›i main lesson timeout
            'default': 50000          // +20s default
        };

        // âœ… NEW: Dedicated Review timeout configuration (HIGHEST - covers 3 Units)
        const reviewTimeouts = {
            'bibi_ctgd': 35000,       // Copy tá»« mainTimeouts  
            'bibi_sgk': 30000,        // Copy tá»« mainTimeouts
            'bibi_lesson_plan': 45000, // Copy tá»« mainTimeouts
            'default': 30000          // Copy tá»« mainTimeouts
        };
        
        // ðŸŽ¯ CONDITIONAL LOGIC: Only extend timeout for supplementary
        if (lessonType === 'supplementary') {
            console.log('â±ï¸ Using EXTENDED timeouts for Supplementary lesson');
            return supplementaryTimeouts;
        } else if (lessonType === 'review') {
            // âœ… ENHANCED: Review needs AGGRESSIVE timeouts (cross-unit complexity)
            console.log('â±ï¸ Using AGGRESSIVE timeouts for Review lesson');
            return reviewTimeouts; // Use dedicated review timeouts
        } else {
            console.log('â±ï¸ Using OPTIMIZED timeouts for Main lesson');
            return mainTimeouts;
        }
    }

    // ThÃªm vÃ o class LessonPlanRAG
    async searchFastFirst(query, options = {}) {
        if (!this.enabled) {
        return { success: false, disabled: true, results: [] };
        }
        
        const lessonType = options.lessonType || 'main';
        
        // 1. XÃ¡c Ä‘á»‹nh namespace Æ°u tiÃªn dá»±a trÃªn loáº¡i giÃ¡o Ã¡n
        let priorityNamespace;
        switch(lessonType) {
        case 'main':
            priorityNamespace = "bibi_ctgd"; // CTGD cho giÃ¡o Ã¡n chÃ­nh
            break;
        case 'supplementary':
            priorityNamespace = "bibi_ctgd"; // CTGD cho tÄƒng tiáº¿t
            break;
        case 'extracurricular':
            priorityNamespace = "bibi_ctgd"; // CTGD cho ngoáº¡i khÃ³a
            break;
        default:
            priorityNamespace = "bibi_ctgd";
        }
        
        console.log(`ðŸš€ TÃ¬m kiáº¿m nhanh trÃªn namespace Æ°u tiÃªn: ${priorityNamespace}`);
        
        // 2. ðŸš€ PARALLEL OPTIMIZATION: Reduced timeout for background processing  
        const fastTimeout = options.timeout || options.fastTimeout || 5000; // ðŸš€ PARALLEL: 10s â†’ 5s for background
        
        try {

        // 3. Táº¡o URL vá»›i query parameters - tá»‘i Æ°u dá»±a vÃ o loáº¡i giÃ¡o Ã¡n
        let url;
        if (this.apiUrl.startsWith('http')) {
            url = new URL(this.apiUrl);
        } else {
            url = new URL(this.apiUrl, window.location.origin);
        }
        url.searchParams.append("query", query);
        url.searchParams.append("namespace", priorityNamespace);

        // Äiá»u chá»‰nh tham sá»‘ dá»±a vÃ o loáº¡i giÃ¡o Ã¡n
        if (options.lessonType === 'supplementary') {
            // Cho supplementary - chá»‰ láº¥y 1 káº¿t quáº£ tá»‘t nháº¥t vÃ  háº¡ threshold
            url.searchParams.append("top_k", 1);
            url.searchParams.append("threshold", "0.55"); // NgÆ°á»¡ng tháº¥p hÆ¡n
            url.searchParams.append("max_tokens", "4000"); // Giá»›i háº¡n kÃ­ch thÆ°á»›c token
        } else {
            // Cho main vÃ  extracurricular
            url.searchParams.append("top_k", 2); // Giáº£m tá»« 3 xuá»‘ng 2
            url.searchParams.append("threshold", "0.7");
        }

        url.searchParams.append("search_all", "true"); // ThÃªm tham sá»‘ search_all
        url.searchParams.append("threshold", "0.6"); // ThÃªm ngÆ°á»¡ng tháº¥p hÆ¡n cho supplementary

        // ThÃªm tham sá»‘ max_tokens cho káº¿t quáº£ ngáº¯n hÆ¡n, nhanh hÆ¡n
        if (options.lessonType === 'supplementary') {
            url.searchParams.append("max_tokens", "8000"); // Giá»›i háº¡n kÃ­ch thÆ°á»›c token
        }
        
        // 4. ThÃªm timeout ngáº¯n Ä‘á»ƒ khÃ´ng Ä‘á»£i quÃ¡ lÃ¢u
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            console.log(`â±ï¸ PARALLEL: Timeout sau ${fastTimeout/1000}s cho namespace Æ°u tiÃªn ${priorityNamespace}`);
        }, fastTimeout);
        
        // 5. Gá»i API tÃ¬m kiáº¿m
        console.log(`â±ï¸ PARALLEL: Äá»£i tá»‘i Ä‘a ${fastTimeout/1000}s cho káº¿t quáº£ nhanh tá»« ${priorityNamespace}`);
        const response = await fetch(url.toString(), {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        // 6. Xá»­ lÃ½ káº¿t quáº£
        if (!response.ok) {
            console.warn(`RAG API tráº£ vá» status code: ${response.status} cho namespace Æ°u tiÃªn`);
            return { success: false, namespace: priorityNamespace, results: [] };
        }
        
        const data = await response.json();
        
        if (data.status === 'error') {
            console.error(`RAG API Error cho ${priorityNamespace}:`, data.message);
            return { success: false, namespace: priorityNamespace, error: data.message, results: [] };
        }
        
        // 7. ÄÃ¡nh dáº¥u nguá»“n cá»§a má»—i káº¿t quáº£
        const results = (data.results || []).map(result => ({
            ...result,
            namespace: priorityNamespace,
            metadata: {
            ...result.metadata,
            namespace: priorityNamespace,
            source: result.metadata?.source || this.getNamespaceDisplayName(priorityNamespace)
            }
        }));
        
        // 8. Tráº£ vá» káº¿t quáº£
        console.log(`âœ… PARALLEL: TÃ¬m tháº¥y ${results.length} káº¿t quáº£ nhanh tá»« namespace Æ°u tiÃªn ${priorityNamespace}`);
        return {
            success: results.length > 0,
            namespace: priorityNamespace,
            results,
            count: results.length,
            prioritySearch: true
        };
        } catch (error) {
        if (error.name === 'AbortError') {
            console.warn(`RAG API timeout cho namespace Æ°u tiÃªn ${priorityNamespace}`);
            return { success: false, namespace: priorityNamespace, error: 'Timeout', results: [] };
        }
        console.error(`Lá»—i khi tÃ¬m kiáº¿m trÃªn namespace Æ°u tiÃªn ${priorityNamespace}:`, error);
        return { success: false, namespace: priorityNamespace, error: error.message, results: [] };
        }
    }
