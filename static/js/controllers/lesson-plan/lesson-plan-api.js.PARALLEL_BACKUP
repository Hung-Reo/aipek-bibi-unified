// /static/js/controllers/lesson-plan/lesson-plan-api.js
// Module káº¿t ná»‘i vá»›i API - CLEANED: Review expansion moved to prompts level
// âœ… SAFE: Only Review logic removed, Main/TT logic preserved
// âœ… UNIFIED: Updated for single server deployment (removed proxy URLs)

import { LessonPlanRAG } from './lesson-plan-rag.js';

export class LessonPlanAPI {
  constructor(options = {}) {
    // âœ… UNIFIED UPDATE: Direct API calls to same server, no proxy
    const baseUrl = window.location.origin; // Same server for unified deployment
    
    this.baseUrl = options.baseUrl || `${baseUrl}/api`;
    
    // âœ… UNIFIED: Direct chat endpoint (no proxy)
    this.chatEndpoint = options.chatEndpoint || `${baseUrl}/api/chat`;
    this.lessonPlanEndpoint = options.lessonPlanEndpoint || `${this.baseUrl}/lesson-plan`;
    
    // Khá»Ÿi táº¡o RAG client
    this.rag = new LessonPlanRAG({
        namespaces: ["bibi_sgk", "bibi_ctgd", "bibi_lesson_plan"],
        defaultNamespace: "bibi_lesson_plan",
        enabled: true,
        debug: options.debug || false
    });
    
    // Kiá»ƒm tra tráº¡ng thÃ¡i káº¿t ná»‘i RAG
    this.ragAvailable = false;
    this.checkRAGStatus();
    
    console.log('ðŸ”Œ LessonPlanAPI khá»Ÿi táº¡o thÃ nh cÃ´ng (unified deployment)');
  }

  // Kiá»ƒm tra tráº¡ng thÃ¡i káº¿t ná»‘i RAG
  async checkRAGStatus() {
    try {
      this.ragAvailable = await this.rag.checkConnection();
      console.log(`RAG Status: ${this.ragAvailable ? 'Connected âœ…' : 'Disconnected âŒ'}`);
      return this.ragAvailable;
    } catch (error) {
      console.error('Error checking RAG status:', error);
      this.ragAvailable = false;
      return false;
    }
  }

  // Gá»­i yÃªu cáº§u Ä‘áº¿n API Ä‘á»ƒ táº¡o giÃ¡o Ã¡n
  async generateLessonPlan(messages, streamCallback, options = {}) {
    try {
      console.log("DEBUG: Báº¯t Ä‘áº§u táº¡o giÃ¡o Ã¡n vá»›i API");
      
      // Khai bÃ¡o biáº¿n kiá»ƒm tra Ä‘á»™ dÃ i NGAY Tá»ª Äáº¦U hÃ m - Ä‘Ã¢y lÃ  pháº§n sá»­a lá»—i chÃ­nh
      let contentLengthChecked = false;
      let startTime = Date.now(); // LÆ°u thá»i Ä‘iá»ƒm báº¯t Ä‘áº§u
      
      // âœ… CLEANED: Removed extracurricular-specific useRAG logic
      const useRAG = options.useRAG !== false && this.ragAvailable;
      const lessonType = options.lessonType || 'main';
      const ragQuery = options.ragQuery || '';
      const modelToUse = options.model || 'gpt-4.1';
      
      // Chuáº©n bá»‹ thÃ´ng tin RAG
      let ragInfo = {
        attempted: useRAG,
        usedRAG: false,
        sources: [],
        searching: useRAG,
        startTime: Date.now(),
        endTime: null,
        error: null,
        namespaces: []
      };
      
      // KhÃ´ng chá» káº¿t quáº£ RAG, gá»­i truy váº¥n RAG song song
      let ragPromise = null;
      
      if (useRAG && ragQuery) {
        // ThÃ´ng bÃ¡o Ä‘ang tÃ¬m kiáº¿m
        streamCallback('', '', {
          ...ragInfo,
          currentStage: "Äang tÃ¬m thÃ´ng tin tham kháº£o..."
        });
        
        console.log("DEBUG: Báº¯t Ä‘áº§u tÃ¬m kiáº¿m RAG", ragQuery);
        
        // Báº¯t Ä‘áº§u tÃ¬m kiáº¿m song song, khÃ´ng chá» Ä‘á»£i
        ragPromise = this.rag.searchFastFirst(ragQuery, {
          lessonType: lessonType,
          timeout: 25000 // ðŸš€ PHASE 2 FIX: 8s â†’ 25s (backend cáº§n 30-45s)
        }).then(results => {
          // Xá»­ lÃ½ káº¿t quáº£ RAG náº¿u thÃ nh cÃ´ng
          if (results && results.success && results.results && results.results.length > 0) {
            console.log(`DEBUG: TÃ¬m tháº¥y ${results.results.length} káº¿t quáº£ RAG`);
            
            // Cáº­p nháº­t thÃ´ng tin RAG
            ragInfo.searching = false;
            ragInfo.endTime = Date.now();
            ragInfo.usedRAG = true;
            ragInfo.sources = results.results.map(result => {
              const metadata = result.metadata || {};
              const source = metadata.source || metadata.namespace || 'ChÆ°Æ¡ng trÃ¬nh giÃ¡o dá»¥c';
              return `${source} - ${result.content?.substring(0, 80)}...`;
            });
            ragInfo.namespaces = Array.from(new Set(results.results.map(r => r.namespace || '')));
            
            // Gá»­i thÃ´ng tin RAG qua callback
            streamCallback('', '', ragInfo);
            
            // ðŸš€ Sá»¬A 3: RAG enhancement sau khi OpenAI Ä‘Ã£ start - inject vÃ o stream
            // LÆ°u RAG results Ä‘á»ƒ inject vÃ o content stream later
            ragInfo.enhancementData = results;
            console.log("DEBUG: LÆ°u RAG results Ä‘á»ƒ enhance content during streaming");
            
            return results;
          } else {
            console.log("DEBUG: KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£ RAG phÃ¹ há»£p");
            ragInfo.searching = false;
            ragInfo.endTime = Date.now();
            ragInfo.usedRAG = false;
            streamCallback('', '', ragInfo);
            return null;
          }
        }).catch(error => {
          console.warn("DEBUG: Lá»—i khi tÃ¬m kiáº¿m RAG:", error.message);
          ragInfo.searching = false;
          ragInfo.endTime = Date.now();
          ragInfo.error = error.message;
          streamCallback('', '', ragInfo);
          return null;
        });
      } else {
        console.log("DEBUG: KhÃ´ng sá»­ dá»¥ng RAG hoáº·c khÃ´ng cÃ³ query");
      }
      
      // Kiá»ƒm tra kÃ­ch thÆ°á»›c messages
      const messagesSize = JSON.stringify(messages).length;
      if (messagesSize > 100000) {
        console.log(`DEBUG: Messages quÃ¡ lá»›n (${messagesSize/1024}KB), tá»‘i Æ°u hÃ³a...`);
        // Tá»‘i Æ°u hÃ³a messages náº¿u cáº§n
      }
      
      // Táº¡o controller cho request
      const abortController = new AbortController();
      const { signal } = abortController;
      
      // Timeout 60 giÃ¢y (optimized from 120s)
      const timeoutId = setTimeout(() => abortController.abort(), 60000);
      
      // âœ… CLEANED: Removed extracurricular override patches
      // Gá»­i API request
      console.log("DEBUG: Gá»­i API request vá»›i", options.maxTokens, "tokens");

      const response = await fetch(this.chatEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          messages: messages,
          model: modelToUse,
          temperature: options.temperature || 0.9,
          top_p: 0.95, // âœ… CLEANED: Removed conditional extracurricular logic
          max_tokens: options.maxTokens || 16000,
          stream: true,
          ragInfo: ragInfo,
          lessonType: options.lessonType || 'main',
          ragQuery: options.ragQuery || '',
          detailed_content: options.requireDetailedContent !== false
        }),
        signal
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        console.error(`DEBUG: API error: ${response.status}`);
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      // Xá»­ lÃ½ streaming
      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let buffer = '';
      let fullContent = '';
      
      console.log("DEBUG: Xá»­ lÃ½ streaming response");
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        buffer += decoder.decode(value, { stream: true });
        
        const lines = buffer.split('\n');
        buffer = lines.pop();
        
        for (const line of lines) {
          if (line.startsWith('data: ') && line !== 'data: [DONE]') {
            try {
              const jsonData = JSON.parse(line.slice(6));
              const content = jsonData.choices[0]?.delta?.content || '';
              if (content) {
                fullContent += content;
                streamCallback(content, fullContent, null);
                
                // Kiá»ƒm tra Ä‘á»™ dÃ i trong quÃ¡ trÃ¬nh streaming
                if (!contentLengthChecked && fullContent.length > 4000) {
                  contentLengthChecked = true;
                  
                  // Dá»± Ä‘oÃ¡n Ä‘á»™ dÃ i cuá»‘i cÃ¹ng
                  const elapsedTime = Date.now() - startTime;
                  const projectedLength = Math.round((fullContent.length / elapsedTime) * 90000); // 90 giÃ¢y
                  
                  // âœ… ENHANCED: Only apply expansion guidance for Main/TT, SKIP Review
                  if (options.lessonType !== 'review' && projectedLength < 13000) {
                    // Keep original expansion logic for Main/TT tabs only
                    console.log(`âš ï¸ Cáº£nh bÃ¡o: Dá»± Ä‘oÃ¡n ná»™i dung sáº½ quÃ¡ ngáº¯n (~${projectedLength} kÃ½ tá»±)`);
                    
                    const expansionGuidance = `\n\nâš ï¸âš ï¸âš ï¸ Cáº¢NH BÃO: Ná»˜I DUNG Dá»° KIáº¾N QUÃ NGáº®N! âš ï¸âš ï¸âš ï¸

                HÃ£y Má»ž Rá»˜NG Táº¤T Cáº¢ cÃ¡c pháº§n tiáº¿p theo vá»›i má»©c Ä‘á»™ chi tiáº¿t cao nháº¥t:

                1. Tiáº¿n trÃ¬nh dáº¡y há»c (Procedures): MÃ´ táº£ Cá»°C Ká»² CHI TIáº¾T tá»«ng hoáº¡t Ä‘á»™ng
                  - Script Ä‘áº§y Ä‘á»§ nhá»¯ng gÃ¬ giÃ¡o viÃªn sáº½ nÃ³i
                  - CÃ¢u há»i vÃ  cÃ¢u tráº£ lá»i máº«u cho má»—i hoáº¡t Ä‘á»™ng
                  - HÆ°á»›ng dáº«n chi tiáº¿t cho má»—i Task

                2. PhÃ¢n tÃ­ch ngÃ´n ngá»¯ (Language Analysis): MÃ´ táº£ Ã­t nháº¥t 10 tá»«/cáº¥u trÃºc
                  - PhÃ¢n tÃ­ch Ä‘áº§y Ä‘á»§ Form, Meaning, Pronunciation, Vietnamese, Example
                  - VÃ­ dá»¥ cá»¥ thá»ƒ cho má»—i tá»«/cáº¥u trÃºc

                3. Táº¥t cáº£ cÃ¡c pháº§n khÃ¡c: Má»Ÿ rá»™ng Ã­t nháº¥t gáº¥p Ä‘Ã´i chi tiáº¿t

                GIÃO ÃN PHáº¢I Äáº T Tá»I THIá»‚U 15,000 KÃ Tá»°!\n\n`;
                    
                    streamCallback(expansionGuidance, fullContent + expansionGuidance, {
                      lengthWarning: true,
                      projected: projectedLength
                    });
                  }
                  // âœ… NEW: Skip any expansion for Review (handled by prompts)
                  else if (options.lessonType === 'review') {
                    console.log(`âœ… Review detected (${projectedLength} chars predicted) - relying on prompt-level expansion`);
                  }
                }
              }
            } catch (e) {
              console.error("DEBUG: Lá»—i khi xá»­ lÃ½ JSON streaming:", e);
            }
          }
        }
      }
      
      console.log(`DEBUG: Streaming hoÃ n táº¥t, tá»•ng ${fullContent.length} kÃ½ tá»±`);
      
      // âœ… ENHANCED: Check content length vá»›i Review bypass
      if (fullContent) {
        // âœ… CLEANED: SGK content length targets only (removed extracurricular)
        let targetLength, minLength;

        if (options.lessonType === 'review') {
          targetLength = 15000;  // Review requirements
          minLength = 13000;     // Production stable
        } else {
          targetLength = 15000;  // main/supplementary stable
          minLength = 12000;     // Production proven
        }

        const currentLength = fullContent.length;

        // âœ… KEY CHANGE: Skip expansion for Review completely
        if (options.lessonType === 'review' || options.lessonType === 'test') {
          console.log(`âœ… Review content: ${currentLength} chars - bypassing API expansion (handled by prompts)`);
          
          // Just log the length for Review, no expansion
          if (!ragInfo) ragInfo = {};
          ragInfo.reviewContentLength = currentLength;
          ragInfo.reviewBypassedExpansion = true;
          streamCallback('', fullContent, ragInfo);
          
        } else if (currentLength < minLength) {
          // âœ… PRESERVE: Main/TT expansion logic unchanged
          console.log(`DEBUG: Ná»™i dung quÃ¡ ngáº¯n (${currentLength} kÃ½ tá»± / ${targetLength} má»¥c tiÃªu cho ${options.lessonType})`);
          
          // TÃ¬m kiáº¿m Ä‘iá»ƒm káº¿t thÃºc - nÆ¡i cÃ³ thá»ƒ chÃ¨n thÃªm thÃ´ng tin
          let insertPoint = fullContent.lastIndexOf("\n\n");
          if (insertPoint === -1) insertPoint = fullContent.length;
          
          // âœ… CLEANED: Removed extracurricular skip logic - continues with SGK expansion
          
          // Táº¡o thÃ´ng bÃ¡o chi tiáº¿t hÆ¡n - for Main/TT only
          let additionalGuidance = `
  
      â€”â€” HÆ¯á»šNG DáºªN Bá»” SUNG â€”â€”
  
      Cáº¢NH BÃO: Ná»™i dung giÃ¡o Ã¡n hiá»‡n táº¡i chá»‰ cÃ³ ${currentLength} kÃ½ tá»±, quÃ¡ ngáº¯n so vá»›i yÃªu cáº§u tá»‘i thiá»ƒu 15,000 kÃ½ tá»±.
  
      YÃŠU Cáº¦U Má»ž Rá»˜NG KHáº¨N Cáº¤P:
      1. MÃ´ táº£ CHI TIáº¾T HÆ N tá»«ng bÆ°á»›c trong pháº§n "Tiáº¿n trÃ¬nh dáº¡y há»c"
      2. ThÃªm Ã­t nháº¥t 10 tá»« vá»±ng/cáº¥u trÃºc vÃ o pháº§n "PhÃ¢n tÃ­ch ngÃ´n ngá»¯" 
      3. Bá»• sung Ã­t nháº¥t 5 khÃ³ khÄƒn dá»± Ä‘oÃ¡n vÃ  giáº£i phÃ¡p tÆ°Æ¡ng á»©ng
      4. Má»—i hoáº¡t Ä‘á»™ng trong tiáº¿n trÃ¬nh dáº¡y há»c cáº§n Ä‘Æ°á»£c mÃ´ táº£ báº±ng Ã­t nháº¥t 10-15 cÃ¢u
      5. Pháº§n Board Plan cáº§n chi tiáº¿t vÃ  Ä‘áº§y Ä‘á»§ hÆ¡n
  
      Táº¥t cáº£ cÃ¡c pháº§n cáº§n Ä‘Æ°á»£c má»Ÿ rá»™ng Ä‘á»ƒ tá»•ng sá»‘ kÃ½ tá»± Ä‘áº¡t Ã­t nháº¥t 15,000.`;

          // ChÃ¨n hÆ°á»›ng dáº«n bá»• sung cho Main/TT
          fullContent = fullContent.substring(0, insertPoint) + additionalGuidance + fullContent.substring(insertPoint);
          
          // LÆ°u Ã½ kiá»ƒm tra Ä‘á»™ dÃ i cho láº§n sau
          if (!ragInfo) ragInfo = {};
          ragInfo.contentTooShort = true;
          ragInfo.currentLength = currentLength;
          ragInfo.targetLength = targetLength;
          streamCallback('', fullContent, ragInfo);
          
        } else if (currentLength < targetLength) {
          // Ná»™i dung Ä‘áº¡t yÃªu cáº§u tá»‘i thiá»ƒu nhÆ°ng chÆ°a Ä‘áº¡t má»¥c tiÃªu - for Main/TT
          console.log(`DEBUG: Ná»™i dung Ä‘á»§ dÃ i nhÆ°ng chÆ°a Ä‘áº¡t má»¥c tiÃªu (${currentLength}/${targetLength} kÃ½ tá»±)`);
          
          if (!ragInfo) ragInfo = {};
          ragInfo.contentAcceptable = true;
          ragInfo.currentLength = currentLength;
          ragInfo.targetLength = targetLength;
        } else {
          // Ná»™i dung Ä‘áº¡t má»¥c tiÃªu
          console.log(`DEBUG: Ná»™i dung Ä‘áº¡t má»¥c tiÃªu (${currentLength}/${targetLength} kÃ½ tá»±)`);
          
          if (!ragInfo) ragInfo = {};
          ragInfo.contentOptimal = true;
          ragInfo.currentLength = currentLength;
          ragInfo.targetLength = targetLength;
        }
      }

      // Äáº£m báº£o ragInfo.searching = false khi káº¿t thÃºc
      if (ragInfo.searching) {
        ragInfo.searching = false;
        ragInfo.endTime = Date.now();
        streamCallback('', fullContent, ragInfo);
      }
      
      // Tráº£ vá» káº¿t quáº£ Ä‘áº§y Ä‘á»§
      return {
        content: fullContent,
        ragInfo
      };
      
    } catch (error) {
      console.error('DEBUG: API Error:', error);
      throw error;
    }
  }

  // LÆ°u giÃ¡o Ã¡n vÃ o localStorage
  saveLessonPlan(lessonPlan) {
    try {
      // Táº¡o ID duy nháº¥t
      const id = `lesson_plan_${Date.now()}`;
      lessonPlan.id = id;
      lessonPlan.createdAt = new Date().toISOString();
      
      // Láº¥y danh sÃ¡ch giÃ¡o Ã¡n hiá»‡n cÃ³
      const savedPlans = JSON.parse(localStorage.getItem('bibi_lesson_plans') || '[]');
      
      // ThÃªm giÃ¡o Ã¡n má»›i
      savedPlans.push(lessonPlan);
      
      // Giá»›i háº¡n sá»‘ lÆ°á»£ng giÃ¡o Ã¡n lÆ°u trá»¯
      if (savedPlans.length > 50) {
        savedPlans.shift(); // XÃ³a giÃ¡o Ã¡n cÅ© nháº¥t
      }
      
      // LÆ°u láº¡i
      localStorage.setItem('bibi_lesson_plans', JSON.stringify(savedPlans));
      
      return id;
    } catch (error) {
      console.error('Error saving lesson plan:', error);
      return null;
    }
  }

  // Láº¥y danh sÃ¡ch giÃ¡o Ã¡n Ä‘Ã£ lÆ°u
  getLessonPlans() {
    try {
      const savedPlans = JSON.parse(localStorage.getItem('bibi_lesson_plans') || '[]');
      return savedPlans.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    } catch (error) {
      console.error('Error getting lesson plans:', error);
      return [];
    }
  }

  // Láº¥y giÃ¡o Ã¡n theo ID
  getLessonPlanById(id) {
    try {
      const savedPlans = JSON.parse(localStorage.getItem('bibi_lesson_plans') || '[]');
      return savedPlans.find(plan => plan.id === id) || null;
    } catch (error) {
      console.error('Error getting lesson plan by ID:', error);
      return null;
    }
  }

  // XÃ³a giÃ¡o Ã¡n theo ID
  deleteLessonPlan(id) {
    try {
      const savedPlans = JSON.parse(localStorage.getItem('bibi_lesson_plans') || '[]');
      const filteredPlans = savedPlans.filter(plan => plan.id !== id);
      localStorage.setItem('bibi_lesson_plans', JSON.stringify(filteredPlans));
      return true;
    } catch (error) {
      console.error('Error deleting lesson plan:', error);
      return false;
    }
  }
}
